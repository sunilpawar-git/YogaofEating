name: CI

on:
  push:
    branches: [ main, development ]
  pull_request:
    branches: [ main, development ]

jobs:
  build-and-test:
    name: Build and Test
    runs-on: macos-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Verify GoogleService-Info.plist exists
      run: |
        if [ ! -f "GoogleService-Info.plist" ]; then
          echo "⚠️ Warning: GoogleService-Info.plist not found. Creating a minimal one for CI."
          cat > GoogleService-Info.plist << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>CLIENT_ID</key>
            <string>ci-test-client-id</string>
            <key>REVERSED_CLIENT_ID</key>
            <string>ci-test-reversed-client-id</string>
            <key>API_KEY</key>
            <string>ci-test-api-key</string>
            <key>GCM_SENDER_ID</key>
            <string>123456789</string>
            <key>PLIST_VERSION</key>
            <string>1</string>
            <key>BUNDLE_ID</key>
            <string>com.yogaofeating.Yoga-of-Eating</string>
            <key>PROJECT_ID</key>
            <string>yoga-of-eating-ci</string>
            <key>STORAGE_BUCKET</key>
            <string>yoga-of-eating-ci.appspot.com</string>
            <key>IS_ADS_ENABLED</key>
            <false/>
            <key>IS_ANALYTICS_ENABLED</key>
            <false/>
            <key>IS_APPINVITE_ENABLED</key>
            <false/>
            <key>IS_GCM_ENABLED</key>
            <false/>
            <key>IS_SIGNIN_ENABLED</key>
            <false/>
            <key>GOOGLE_APP_ID</key>
            <string>1:123456789:ios:abcdef123456</string>
        </dict>
        </plist>
        EOF
        fi
      
    - name: Show Xcode version
      run: xcodebuild -version
      
    - name: Show Swift version
      run: swift --version
      
    - name: Cache Swift Package Manager dependencies
      uses: actions/cache@v4
      with:
        path: .build
        key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-spm-
          
    - name: Cache DerivedData
      uses: actions/cache@v4
      with:
        path: ~/Library/Developer/Xcode/DerivedData
        key: ${{ runner.os }}-deriveddata-${{ hashFiles('**/*.xcodeproj/project.pbxproj') }}
        restore-keys: |
          ${{ runner.os }}-deriveddata-
          
    - name: Resolve Swift Package dependencies
      run: |
        xcodebuild -resolvePackageDependencies \
          -project "Yoga of Eating.xcodeproj" \
          -scheme "Yoga of Eating"
          
    - name: List available simulators
      run: xcrun simctl list devices available
      
    - name: Get available iOS simulator
      id: simulator
      run: |
        # Get the first available iPhone simulator UUID
        SIMULATOR_UUID=$(xcrun simctl list devices available | grep -i "iphone" | grep -v "unavailable" | head -1 | grep -oE '[A-F0-9]{8}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{12}' | head -1)
        if [ -z "$SIMULATOR_UUID" ]; then
          # Fallback: get any iPhone simulator
          SIMULATOR_UUID=$(xcrun simctl list devices | grep -i "iphone" | head -1 | grep -oE '[A-F0-9]{8}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{4}-[A-F0-9]{12}' | head -1)
        fi
        echo "simulator_uuid=$SIMULATOR_UUID" >> $GITHUB_OUTPUT
        echo "Using simulator UUID: $SIMULATOR_UUID"
        if [ -z "$SIMULATOR_UUID" ]; then
          echo "⚠️ Warning: No simulator found, will use default"
        fi
      
    - name: Build project
      run: |
        if [ -n "${{ steps.simulator.outputs.simulator_uuid }}" ]; then
          DESTINATION="platform=iOS Simulator,id=${{ steps.simulator.outputs.simulator_uuid }}"
        else
          DESTINATION="platform=iOS Simulator,name=iPhone 15"
        fi
        xcodebuild clean build \
          -project "Yoga of Eating.xcodeproj" \
          -scheme "Yoga of Eating" \
          -destination "$DESTINATION" \
          -configuration Debug \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO
          
    - name: Run unit tests
      run: |
        if [ -n "${{ steps.simulator.outputs.simulator_uuid }}" ]; then
          DESTINATION="platform=iOS Simulator,id=${{ steps.simulator.outputs.simulator_uuid }}"
        else
          DESTINATION="platform=iOS Simulator,name=iPhone 15"
        fi
        xcodebuild test \
          -project "Yoga of Eating.xcodeproj" \
          -scheme "Yoga of Eating" \
          -destination "$DESTINATION" \
          -only-testing:"Yoga of EatingTests" \
          -configuration Debug \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO
          
    - name: Run UI tests (optional - may be flaky)
      continue-on-error: true
      run: |
        if [ -n "${{ steps.simulator.outputs.simulator_uuid }}" ]; then
          DESTINATION="platform=iOS Simulator,id=${{ steps.simulator.outputs.simulator_uuid }}"
        else
          DESTINATION="platform=iOS Simulator,name=iPhone 15"
        fi
        xcodebuild test \
          -project "Yoga of Eating.xcodeproj" \
          -scheme "Yoga of Eating" \
          -destination "$DESTINATION" \
          -only-testing:"Yoga of EatingUITests" \
          -configuration Debug \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO
